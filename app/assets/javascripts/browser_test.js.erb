// TODO list
/*
   rename p tags to be more consistent
   #continuinty-form, #continuity-display
   more object oriented?
 */

function googleAnalytics(){
  if (typeof _gat ===  'undefined') {
    appendToOtherSites(false, "Google Analytics: Not Loaded");
  }else{
    appendToOtherSites(true, "Google Analytics: Loaded");
  }
}
function googlejsapi(){
  if (typeof google.loader === 'undefined') {
    appendToOtherSites(false, "jsapi: Not Loaded");
  }else{
    appendToOtherSites(true, "jsapi: Loaded");
  }
}

function styleAsPassed(domID) {
  $(domID).parents(".alert").removeClass("grey").removeClass('alert-error').addClass("alert-success");
}

function styleAsFailed(domID) {
  $(domID).parents(".alert").removeClass("grey").addClass("alert-error");
}

function blacklisted() {
  var parser = new UAParser();
  var browser = parser.getResult().browser.name;
  var version = parseFloat(parser.getResult().browser.version);

  if(browser == 'IE' && version < 8.0){
    return true;
  }else{
    return false;
  }
}

//Google Analytics
var _gaq = _gaq || [];

_gaq.push(['_setAccount', '<%= ENV["gaA"]%>']);
_gaq.push(['_trackPageview']);

//honey badger
$(function(){ Honeybadger.configure({
  api_key: '097b0947f2920dc6355327d2c1c2d1f8' // Public API key
});
try {
  testAll();
} catch(e) {
  Honeybadger.notify(e);
}});

//3rd party site count
var third_party_site_loads;
var third_party_site_failures;

function test(id, testFunction) {
  function userDatumId(test_id) {
    return '#user_datum_' + test_id.substring(1);
  }

  var pass = function(message) {
    styleAsPassed(id);
    $(id).text(message);
    var user_datum_id = userDatumId(id);
    $(user_datum_id).val(message);
  };

  var fail = function(message) {
    styleAsFailed(id);
    $(id).text(message);
    var user_datum_id = userDatumId(id);
    $(user_datum_id).val(message);
  }

  testFunction(pass, fail);
}

function testAll(){
  // alert dismissal
  // $(".alert").alert();
  third_party_site_loads = 0;
  third_party_site_failures = 0;

  //loading data from client
  test('#user_agent_string', function(pass, fail) {
    if (navigator.userAgent == undefined) {
      fail('Undefined');
    } else if (blacklisted()) {
      fail(navigator.userAgent + "\n Your browser may be in a compatibility mode supporting an older version of IE.");
    } else {
      pass(navigator.userAgent);
    }
  });

  test('#window_size', function(pass, fail) {
    var viewport = window.session.device.viewport;
    if (viewport.width == undefined && viewport.height == undefined) {
      fail('Undefined');
    } else {
      pass(viewport.width + " x " + viewport.height);
    }
  });

  test('#screen_size', function(pass, fail) {
    screen = window.session.device.screen;
    if (screen.width == undefined && screen.height == undefined) {
      fail("Undefined");
    } else {
      pass(screen.width + " x " +screen.height);
    }
  });

  if(window.session.browser.os == undefined){
    $("#operating_system").text("Undefined");
    styleAsFailed("#operating_system");
    $("#user_datum_operating_system").val("Undefined");
  }else{
    $("#operating_system").text(window.session.browser.os);
    styleAsPassed("#operating_system");
    $("#user_datum_operating_system").val(window.session.browser.os);
  }

  if(window.session.browser.browser == undefined && window.session.browser.version == undefined){
    $("#web_browser").text("Undefined");
    styleAsFailed("#web_browser");
    $("#user_datum_web_browser").val("Undefined");
  }else{
    $("#web_browser").text(window.session.browser.browser + " Version: " + window.session.browser.version);
    styleAsPassed("#web_browser");
    $("#user_datum_web_browser").val(window.session.browser.browser + " Version: " + window.session.browser.version);
  }

  if(window.session.plugins.flash == true && window.session.plugins.flash != undefined){
    $("#flash_enabled").text(window.session.plugins.flash);
    styleAsPassed("#flash_enabled");
    $("#user_datum_flash_enabled").val(window.session.plugins.flash);
  }else{
    $("#flash_enabled").text("False");
    styleAsFailed("#flash_enabled");
    $("#user_datum_flash_enabled").val("False");
  }
  if(Date() == undefined){
    $("#date").text("Undefined");
    styleAsFailed("#date");
    $("#user_datum_date").val("Undefined");
  }else{
    $("#date").text(Date());
    styleAsPassed("#date");
    $("#user_datum_date").val(Date());
  }

  //Load data from control site https://control.continuity.net/favicon.ico
  $('#imagefavicon').on("error", function() {
    $("#continuity_site").text("Not Loaded");
    styleAsFailed("#continuity_site");
    $("#user_datum_continuity_site").val("Not Loaded");
  });
  $('#imagefavicon').on("load", function(){
    $("#continuity_site").text("Loaded");
    styleAsPassed("#continuity_site");
    $("#user_datum_continuity_site").val("Loaded");
  });
  $('#imagefavicon').attr('src', "https://control.continuity.net/browser-test.png");

  //loading data from 3rd party sites
  //beacon-3.newrelic.com - JavaScript performance monitoring
  if(typeof NREUM === 'undefined'){
    appendToOtherSites(false, "NewRelic: Not Loaded");
  }else{
    appendToOtherSites(true, "NewRelic: Loaded");
  }

  //google.com/jsapi - Google for CDN of JS libraries
  googlejsapi();

  //ssl.google-analytics.com - Site-usage analytics
  googleAnalytics();

  //assets-cdn.continuity.net - Continuity Control's Content CDN
  if(typeof control.datepicker_opts === 'undefined'){
    appendToOtherSites(false, "CloudFront(assets-cdn.continuity.net): Not Loaded");
  }else{
    appendToOtherSites(true, "CloudFront(assets-cdn.continuity.net): Loaded");
  }

  //Honey badger

  if(typeof Honeybadger === 'undefined'){
    appendToOtherSites(false,'HoneyBadger: Not Loaded');
  } else {
    appendToOtherSites(true,'HoneyBadger: Loaded');
  }

}
function appendToOtherSites(loaded, text_to_display) {
  // set string
  if(loaded){
    third_party_site_loads += 1;
    if(third_party_site_loads == 1) {
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  } else {
    third_party_site_failures += 1;
    if(third_party_site_failures == 1){
      $("#other_sites").text(
        text_to_display
      );
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#other_sites").text(
        $("#other_sites").text() + ", " + text_to_display
      );
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  }

  // handle completion of loads and failures
  if(third_party_site_loads == 5){
    $("#other_sites").text('All loaded');
    styleAsPassed("#other_sites");
  } else if (third_party_site_loads + third_party_site_failures == 6) {
    styleAsFailed("#other_sites");
  }
}
