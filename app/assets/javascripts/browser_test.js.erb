// TODO list
/*
   rename p tags to be more consistent
   #continuinty-form, #continuity-display
   more object oriented?
 */

function googleAnalytics(){
  if (typeof _gat ===  'undefined') {
    appendToOtherSites(false, "Google Analytics: Not Loaded");
  }else{
    appendToOtherSites(true, "Google Analytics: Loaded");
  }
}
function googlejsapi(){
  if (typeof google.loader === 'undefined') {
    appendToOtherSites(false, "jsapi: Not Loaded");
  }else{
    appendToOtherSites(true, "jsapi: Loaded");
  }
}

function styleAsPassed(domID) {
  $(domID).parents(".alert").removeClass("grey").removeClass('alert-error').addClass("alert-success");
}

function styleAsFailed(domID) {
  $(domID).parents(".alert").removeClass("grey").addClass("alert-error");
}

function blacklisted() {
  var parser = new UAParser();
  var browser = parser.getResult().browser.name;
  var version = parseFloat(parser.getResult().browser.version);

  if(browser == 'IE' && version < 8.0){
    return true;
  }else{
    return false;
  }
}

//Google Analytics
var _gaq = _gaq || [];

_gaq.push(['_setAccount', '<%= ENV["gaA"]%>']);
_gaq.push(['_trackPageview']);

//honey badger
$(function(){ Honeybadger.configure({
  api_key: '097b0947f2920dc6355327d2c1c2d1f8' // Public API key
});
try {
  testAll();
} catch(e) {
  Honeybadger.notify(e);
}});

//3rd party site count
var third_party_site_loads;
var third_party_site_failures;

function testAll(){
  // alert dismissal
  // $(".alert").alert();
  third_party_site_loads = 0;
  third_party_site_failures = 0;

  //loading data from client
  if(navigator.userAgent == undefined){
    styleAsFailed("#userAgent");
    $("#userAgent").text("Undefined");
    $("#user_datum_user_agent_string").val("Undefined");
  }else if(blacklisted()){
    styleAsFailed("#userAgent");
    $("#userAgent").text(navigator.userAgent);
    $("#userAgent").append("\n Your browser may be in a compatibility mode supporting an older version of IE.");
    $("#user_datum_user_agent_string").val(navigator.userAgent);
  }else{
    $("#userAgent").text(navigator.userAgent);
    styleAsPassed("#userAgent");
    $("#user_datum_user_agent_string").val(navigator.userAgent);
  }

  if(window.session.device.viewport.width == undefined && window.session.device.viewport.height == undefined){
    $("#windowSize").text("Undefined");
    styleAsFailed("#windowSize");
    $("#user_datum_window_size").val("Undefined");
  }else{
    $("#windowSize").text( window.session.device.viewport.width + " x "+ window.session.device.viewport.height);
    styleAsPassed("#windowSize");
    $("#user_datum_window_size").val(window.session.device.viewport.width + " x "+ window.session.device.viewport.height);
  }

  if(window.session.device.screen.width == undefined && window.session.device.screen.height == undefined){
    $("#screenSize").text("Undefined");
    styleAsFailed("#screenSize");
    $("#user_datum_screen_size").val("Undefined");
  }else{
    $("#screenSize").text(window.session.device.screen.width + " x " + window.session.device.screen.height);
    styleAsPassed("#screenSize");
    $("#user_datum_screen_size").val(window.session.device.screen.width + " x " + window.session.device.screen.height);
  }

  if(window.session.browser.os == undefined){
    $("#os").text("Undefined");
    styleAsFailed("#os");
    $("#user_datum_operating_system").val("Undefined");
  }else{
    $("#os").text(window.session.browser.os);
    styleAsPassed("#os");
    $("#user_datum_operating_system").val(window.session.browser.os);
  }

  if(window.session.browser.browser == undefined && window.session.browser.version == undefined){
    $("#browser").text("Undefined");
    styleAsFailed("#browser");
    $("#user_datum_web_browser").val("Undefined");
  }else{
    $("#browser").text(window.session.browser.browser + " Version: " + window.session.browser.version);
    styleAsPassed("#browser");
    $("#user_datum_web_browser").val(window.session.browser.browser + " Version: " + window.session.browser.version);
  }

  if(window.session.plugins.flash == true && window.session.plugins.flash != undefined){
    $("#flashEnabled").text(window.session.plugins.flash);
    styleAsPassed("#flashEnabled");
    $("#user_datum_flash_enabled").val(window.session.plugins.flash);
  }else{
    $("#flashEnabled").text("False");
    styleAsFailed("#flashEnabled");
    $("#user_datum_flash_enabled").val("False");
  }
  if(Date() == undefined){
    $("#date").text("Undefined");
    styleAsFailed("#date");
    $("#user_datum_date").val("Undefined");
  }else{
    $("#date").text(Date());
    styleAsPassed("#date");
    $("#user_datum_date").val(Date());
  }

  //Load data from control site https://control.continuity.net/favicon.ico
  $('#imagefavicon').on("error", function() {
    $("#continuity").text("Not Loaded");
    styleAsFailed("#continuity");
    $("#user_datum_continuity_site").val("Not Loaded");
  });
  $('#imagefavicon').on("load", function(){
    $("#continuity").text("Loaded");
    styleAsPassed("#continuity");
    $("#user_datum_continuity_site").val("Loaded");
  });
  $('#imagefavicon').attr('src', "https://control.continuity.net/browser-test.png");

  //loading data from 3rd party sites
  //beacon-3.newrelic.com - JavaScript performance monitoring
  if(typeof NREUM === 'undefined'){
    appendToOtherSites(false, "NewRelic: Not Loaded");
  }else{
    appendToOtherSites(true, "NewRelic: Loaded");
  }

  //google.com/jsapi - Google for CDN of JS libraries
  googlejsapi();

  //ssl.google-analytics.com - Site-usage analytics
  googleAnalytics();

  //assets-cdn.continuity.net - Continuity Control's Content CDN
  if(typeof control.datepicker_opts === 'undefined'){
    appendToOtherSites(false, "CloudFront(assets-cdn.continuity.net): Not Loaded");
  }else{
    appendToOtherSites(true, "CloudFront(assets-cdn.continuity.net): Loaded");
  }

  //Honey badger

  if(typeof Honeybadger === 'undefined'){
    appendToOtherSites(false,'HoneyBadger: Not Loaded');
  } else {
    appendToOtherSites(true,'HoneyBadger: Loaded');
  }

}
function appendToOtherSites(loaded, text_to_display) {
  // set string
  if(loaded){
    third_party_site_loads += 1;
    if(third_party_site_loads == 1) {
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  } else {
    third_party_site_failures += 1;
    if(third_party_site_failures == 1){
      $("#3rdparty").text(
        text_to_display
      );
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#3rdparty").text(
        $("#3rdparty").text() + ", " + text_to_display
      );
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  }

  // handle completion of loads and failures
  if(third_party_site_loads == 5){
    $("#3rdparty").text('All loaded');
    styleAsPassed("#3rdparty");
  } else if (third_party_site_loads + third_party_site_failures == 6) {
    styleAsFailed("#3rdparty");
  }
}
