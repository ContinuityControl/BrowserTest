// TODO list
/*
   rename p tags to be more consistent
   #continuinty-form, #continuity-display
   more object oriented?
 */

function styleAsPassed(domID) {
  $(domID).parents(".alert").removeClass("grey").removeClass('alert-error').addClass("alert-success");
}

function styleAsFailed(domID) {
  $(domID).parents(".alert").removeClass("grey").addClass("alert-error");
}

function blacklisted() {
  var parser = new UAParser();
  var browser = parser.getResult().browser.name;
  var version = parseFloat(parser.getResult().browser.version);

  if(browser == 'IE' && version < 8.0){
    return true;
  }else{
    return false;
  }
}

//Google Analytics
var _gaq = _gaq || [];

_gaq.push(['_setAccount', '<%= ENV["gaA"]%>']);
_gaq.push(['_trackPageview']);

//honey badger
$(function(){ Honeybadger.configure({
  api_key: '097b0947f2920dc6355327d2c1c2d1f8' // Public API key
});
try {
  testAll();
} catch(e) {
  Honeybadger.notify(e);
}});

//3rd party site count
var third_party_site_loads;
var third_party_site_failures;

function test(id, testFunction) {
  function userDatumId(test_id) {
    return '#user_datum_' + test_id.substring(1);
  }

  var pass = function(message) {
    styleAsPassed(id);
    $(id).text(message);
    var user_datum_id = userDatumId(id);
    $(user_datum_id).val(message);
  };

  var fail = function(message) {
    styleAsFailed(id);
    $(id).text(message);
    var user_datum_id = userDatumId(id);
    $(user_datum_id).val(message);
  }

  testFunction(pass, fail);
}

function testAll(){
  // alert dismissal
  // $(".alert").alert();
  third_party_site_loads = 0;
  third_party_site_failures = 0;

  //loading data from client
  test('#user_agent_string', function(pass, fail) {
    if (navigator.userAgent == undefined) {
      fail('Undefined');
    } else if (blacklisted()) {
      fail(navigator.userAgent + "\n Your browser may be in a compatibility mode supporting an older version of IE.");
    } else {
      pass(navigator.userAgent);
    }
  });

  test('#window_size', function(pass, fail) {
    var viewport = window.session.device.viewport;
    if (viewport.width == undefined && viewport.height == undefined) {
      fail('Undefined');
    } else {
      pass(viewport.width + " x " + viewport.height);
    }
  });

  test('#screen_size', function(pass, fail) {
    screen = window.session.device.screen;
    if (screen.width == undefined && screen.height == undefined) {
      fail("Undefined");
    } else {
      pass(screen.width + " x " +screen.height);
    }
  });

  test('#operating_system', function(pass, fail) {
    if (window.session.browser.os == undefined) {
      fail("Undefined");
    } else {
      pass(window.session.browser.os);
    }
  });

  test('#web_browser', function(pass, fail) {
    var browser = window.session.browser;
    if (browser.browser == undefined && browser.version == undefined) {
      fail("Undefined");
    } else {
      pass(browser.browser + " Version: " + browser.version);
    }
  });

  test('#flash_enabled', function(pass, fail) {
    if (window.session.plugins.flash == true && window.session.plugins.flash != undefined) {
      pass(window.session.plugins.flash);
    } else {
      fail("False");
    }
  });

  test('#date', function(pass, fail) {
    if (Date() == undefined) {
      fail('Undefined');
    } else {
      pass(Date());
    }
  });

  test('#continuity_site', function(pass, fail) {
    //Load data from control site https://control.continuity.net/favicon.ico
    $('#imagefavicon').on("error", function() {
      fail('Not Loaded');
    });
    $('#imagefavicon').on("load", function(){
      pass('Loaded');
    });
    $('#imagefavicon').attr('src', "https://control.continuity.net/browser-test.png");
  });

  //loading data from 3rd party sites
  //beacon-3.newrelic.com - JavaScript performance monitoring
  if(typeof NREUM === 'undefined'){
    appendToOtherSites(false, "NewRelic: Not Loaded");
  }else{
    appendToOtherSites(true, "NewRelic: Loaded");
  }

  //google.com/jsapi - Google for CDN of JS libraries
  if (typeof google.loader === 'undefined') {
    appendToOtherSites(false, "jsapi: Not Loaded");
  }else{
    appendToOtherSites(true, "jsapi: Loaded");
  }

  //ssl.google-analytics.com - Site-usage analytics
  if (typeof _gat ===  'undefined') {
    appendToOtherSites(false, "Google Analytics: Not Loaded");
  }else{
    appendToOtherSites(true, "Google Analytics: Loaded");
  }

  //assets-cdn.continuity.net - Continuity Control's Content CDN
  if(typeof control.datepicker_opts === 'undefined'){
    appendToOtherSites(false, "CloudFront(assets-cdn.continuity.net): Not Loaded");
  }else{
    appendToOtherSites(true, "CloudFront(assets-cdn.continuity.net): Loaded");
  }

  //Honey badger

  if(typeof Honeybadger === 'undefined'){
    appendToOtherSites(false,'HoneyBadger: Not Loaded');
  } else {
    appendToOtherSites(true,'HoneyBadger: Loaded');
  }

}
function appendToOtherSites(loaded, text_to_display) {
  // set string
  if(loaded){
    third_party_site_loads += 1;
    if(third_party_site_loads == 1) {
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  } else {
    third_party_site_failures += 1;
    if(third_party_site_failures == 1){
      $("#other_sites").text(
        text_to_display
      );
      $("#user_datum_other_sites").val(
        text_to_display
      );
    } else {
      $("#other_sites").text(
        $("#other_sites").text() + ", " + text_to_display
      );
      $("#user_datum_other_sites").val(
        $("#user_datum_other_sites").val() + ", " + text_to_display
      );
    }
  }

  // handle completion of loads and failures
  if(third_party_site_loads == 5){
    $("#other_sites").text('All loaded');
    styleAsPassed("#other_sites");
  } else if (third_party_site_loads + third_party_site_failures == 6) {
    styleAsFailed("#other_sites");
  }
}
